#!/usr/bin/env bash
#
# Git pre-commit hook: INDEX.md 自動再生成
#
# このフックは、docs/ 配下の特定ディレクトリに変更があった場合、
# 該当する INDEX.md を自動的に再生成してステージングします。
#
# 関連: ADR-0015 (docs/decisions/active/2025/10/20251030_0015_git-hooks-index-generation_tooling.md)
#

set -e

# カラー出力定義
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# エラーハンドリング
trap 'echo -e "${RED}❌ INDEX.md 生成中にエラーが発生しました${NC}" >&2; exit 1' ERR

echo -e "${BLUE}🔍 INDEX.md 自動再生成フックを実行中...${NC}"

# ステージされた変更ファイルを取得
STAGED_FILES=$(git diff --cached --name-only)

# 再生成が必要な対象を記録するフラグ（重複排除）
NEED_DECISIONS=0
NEED_PRD=0
NEED_OPERATIONS=0
NEED_GOVERNANCE=0

# 各ディレクトリの変更を検知
while IFS= read -r file; do
    case "$file" in
        # docs/decisions/ 配下（INDEX.md, README.md を除く .md ファイル）
        docs/decisions/active/*.md|docs/decisions/active/*/*.md|docs/decisions/active/*/*/*.md|\
        docs/decisions/deprecated/*.md|docs/decisions/deprecated/*/*.md|docs/decisions/deprecated/*/*/*.md|\
        docs/decisions/superseded/*.md|docs/decisions/superseded/*/*.md|docs/decisions/superseded/*/*/*.md)
            if [[ "$file" != *"/INDEX.md" ]] && [[ "$file" != *"/README.md" ]]; then
                NEED_DECISIONS=1
            fi
            ;;
        
        # docs/prd/ 配下（INDEX.md, README.md を除く .md ファイル）
        docs/prd/active/*.md|docs/prd/implemented/*.md|docs/prd/deprecated/*.md)
            if [[ "$file" != *"/INDEX.md" ]] && [[ "$file" != *"/README.md" ]]; then
                NEED_PRD=1
            fi
            ;;
        
        # docs/operations/ 配下（INDEX.md, README.md を除く .md ファイル）
        docs/operations/current/*.md|docs/operations/archive/*.md|docs/operations/archive/*/*.md|docs/operations/archive/*/*/*.md)
            if [[ "$file" != *"/INDEX.md" ]] && [[ "$file" != *"/README.md" ]]; then
                NEED_OPERATIONS=1
            fi
            ;;
        
        # docs/governance/ 配下（INDEX.md, README.md を除く .md, .yml, .yaml ファイル）
        docs/governance/*.md|docs/governance/*.yml|docs/governance/*.yaml)
            if [[ "$file" != *"/INDEX.md" ]] && [[ "$file" != *"/README.md" ]]; then
                NEED_GOVERNANCE=1
            fi
            ;;
    esac
done <<< "$STAGED_FILES"

# 対象がない場合は終了
if [ $NEED_DECISIONS -eq 0 ] && [ $NEED_PRD -eq 0 ] && [ $NEED_OPERATIONS -eq 0 ] && [ $NEED_GOVERNANCE -eq 0 ]; then
    echo -e "${GREEN}✅ INDEX.md の再生成は不要です${NC}"
    exit 0
fi

# docs/decisions/ の INDEX.md を再生成
if [ $NEED_DECISIONS -eq 1 ]; then
    echo -e "${YELLOW}📋 docs/decisions の変更を検知 → INDEX.md を再生成中...${NC}"
    python scripts/generate_index.py --target adr
    git add docs/decisions/INDEX.md
    echo -e "${GREEN}✅ docs/decisions/INDEX.md を更新しました${NC}"
fi

# docs/prd/ の INDEX.md を再生成
if [ $NEED_PRD -eq 1 ]; then
    echo -e "${YELLOW}📋 docs/prd の変更を検知 → INDEX.md を再生成中...${NC}"
    python scripts/generate_index.py --target prd
    git add docs/prd/INDEX.md
    echo -e "${GREEN}✅ docs/prd/INDEX.md を更新しました${NC}"
fi

# docs/operations/ の INDEX.md を再生成
if [ $NEED_OPERATIONS -eq 1 ]; then
    echo -e "${YELLOW}📋 docs/operations の変更を検知 → INDEX.md を再生成中...${NC}"
    python scripts/generate_index.py --target operations
    git add docs/operations/INDEX.md
    echo -e "${GREEN}✅ docs/operations/INDEX.md を更新しました${NC}"
fi

# docs/governance/ の INDEX.md を再生成
if [ $NEED_GOVERNANCE -eq 1 ]; then
    echo -e "${YELLOW}📋 docs/governance の変更を検知 → INDEX.md を再生成中...${NC}"
    python scripts/generate_index.py --target governance
    git add docs/governance/INDEX.md
    echo -e "${GREEN}✅ docs/governance/INDEX.md を更新しました${NC}"
fi

echo -e "${GREEN}✅ INDEX.md 自動再生成が完了しました${NC}"
echo ""
echo -e "${BLUE}💡 このフックをスキップしたい場合は 'git commit --no-verify' を使用してください${NC}"

exit 0

